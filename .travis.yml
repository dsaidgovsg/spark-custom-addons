language: bash

env:
  global:
  - IMAGE_NAME=${DOCKER_USERNAME}/spark-custom-addons

matrix:
  include:
  # Debian builds

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=3.1.0
    - AWS_JAVA_SDK_VERSION=1.11.271
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=3.1.0
    - AWS_JAVA_SDK_VERSION=1.11.271
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.3.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.3.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=debian

  # Alpine builds

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=3.1.0
    - AWS_JAVA_SDK_VERSION=1.11.271
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=3.1.0
    - AWS_JAVA_SDK_VERSION=1.11.271
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.4.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.3.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.3.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=true
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - HADOOP_VERSION=2.7.3
    - AWS_JAVA_SDK_VERSION=1.7.4
    - WITH_KUBERNETES=false
    - WITH_HIVE=true
    - WITH_PYSPARK=true
    - DIST=alpine

  
script:
- docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
- KUBERNETES_TAG_SUFFIX=$(if [ "${WITH_KUBERNETES}" = "true" ]; then echo _k8s; fi)
- HIVE_TAG_SUFFIX=$(if [ "${WITH_HIVE}" = "true" ]; then echo _hive; fi)
- PYSPARK_TAG_SUFFIX=$(if [ "${WITH_PYSPARK}" = "true" ]; then echo _pyspark; fi)
- DIST_TAG_SUFFIX=_${DIST}
- TAG_NAME=${SPARK_VERSION}_hadoop-${HADOOP_VERSION}${KUBERNETES_TAG_SUFFIX}${HIVE_TAG_SUFFIX}${PYSPARK_TAG_SUFFIX}${DIST_TAG_SUFFIX}
- FULL_IMAGE_NAME="${IMAGE_NAME}:${TAG_NAME}"
- |-
  docker build ${DIST}/ -t ${FULL_IMAGE_NAME} \
    --build-arg SPARK_VERSION=${SPARK_VERSION} \
    --build-arg HADOOP_VERSION=${HADOOP_VERSION} \
    --build-arg AWS_JAVA_SDK_VERSION=${AWS_JAVA_SDK_VERSION} \
    --build-arg KUBERNETES_TAG_SUFFIX=${KUBERNETES_TAG_SUFFIX} \
    --build-arg HIVE_TAG_SUFFIX=${HIVE_TAG_SUFFIX} \
    --build-arg PYSPARK_TAG_SUFFIX=${PYSPARK_TAG_SUFFIX} \
    --build-arg DIST_TAG_SUFFIX=${DIST_TAG_SUFFIX} \
    ;
# Just push, doesn't matter if it's TRAVIS_PULL_REQUEST false/true
- docker push ${FULL_IMAGE_NAME};

branches:
  only:
  - master
